name: Flutter CI - auto unzip & build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      FLUTTER_VERSION: "stable"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install unzip
        run: sudo apt-get update && sudo apt-get install -y unzip

      - name: Find latest zip file
        id: findzip
        run: |
          ZIP=$(git ls-files '*.zip' | xargs -I{} stat -c "%Y %n" {} 2>/dev/null | sort -nr | head -n1 | awk '{print $2}')
          if [ -z "$ZIP" ]; then
            echo "no_zip=true" >> $GITHUB_OUTPUT
          else
            echo "zip_path=$ZIP" >> $GITHUB_OUTPUT
            echo "no_zip=false" >> $GITHUB_OUTPUT
          fi

      - name: Unzip if found
        if: steps.findzip.outputs.no_zip == 'false'
        run: |
          echo "Unzipping ${{ steps.findzip.outputs.zip_path }}"
          mkdir -p extracted
          unzip -o "${{ steps.findzip.outputs.zip_path }}" -d extracted
          ls -la extracted

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Confirm Flutter version
        run: flutter --version

      - name: Set working directory (auto-detect pubspec)
        run: |
          ROOT="."
          if [ -d extracted ] && [ "$(ls -A extracted)" ]; then
            ROOT="extracted"
          fi
          PUBSPEC_DIR=$(find "$ROOT" -maxdepth 2 -type f -name pubspec.yaml -printf '%h\n' | head -n1)
          if [ -n "$PUBSPEC_DIR" ]; then
            echo "WORKDIR=$PUBSPEC_DIR" >> $GITHUB_ENV
            echo "Found pubspec at: $PUBSPEC_DIR"
          else
            echo "WORKDIR=$ROOT" >> $GITHUB_ENV
            echo "No pubspec.yaml found; using $ROOT"
          fi

      - name: Install dependencies
        working-directory: ${{ env.WORKDIR }}
        run: |
          if [ -f pubspec.yaml ]; then
            flutter pub get
          else
            echo "No pubspec.yaml found in ${{ env.WORKDIR }}"
          fi

      - name: Build APK
        working-directory: ${{ env.WORKDIR }}
        run: flutter build apk --release

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: ${{ env.WORKDIR }}/build/app/outputs/flutter-apk/*.apk
