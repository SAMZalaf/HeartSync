name: Flutter CI - auto-fix Android & build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      FLUTTER_CHANNEL: "stable"
      FLUTTER_GIT_URL: "https://github.com/flutter/flutter.git"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install prerequisites
        run: sudo apt-get update && sudo apt-get install -y unzip git wget

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Flutter (subosito) - allow failure
        id: flutter_action
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_CHANNEL }}
        continue-on-error: true

      - name: Ensure flutter available (fallback to git clone)
        if: ${{ failure() }}
        run: |
          if ! command -v flutter >/dev/null 2>&1; then
            echo "Installing Flutter from git (stable) as fallback..."
            FLUTTER_DIR="${RUNNER_TEMP}/flutter"
            rm -rf "$FLUTTER_DIR"
            git clone --depth 1 --branch ${{ env.FLUTTER_CHANNEL }} ${{ env.FLUTTER_GIT_URL }} "$FLUTTER_DIR"
            echo "$FLUTTER_DIR/bin" >> $GITHUB_PATH
          fi

      - name: Confirm Flutter & Java
        run: |
          java -version || true
          flutter --version || true

      - name: Find project root (pubspec) and set WORKDIR
        id: find_root
        run: |
          ROOT="."
          if [ -d extracted ] && [ "$(ls -A extracted)" ]; then
            ROOT="extracted"
          fi
          PUBSPEC_DIR=$(find "$ROOT" -maxdepth 4 -type f -name pubspec.yaml -printf '%h\n' | head -n1 || true)
          if [ -n "$PUBSPEC_DIR" ]; then
            echo "WORKDIR=$PUBSPEC_DIR" >> $GITHUB_ENV
            echo "Found pubspec at: $PUBSPEC_DIR"
          else
            echo "WORKDIR=$ROOT" >> $GITHUB_ENV
            echo "No pubspec.yaml found; using $ROOT"
          fi

      - name: Diagnostic - list WORKDIR contents
        run: |
          echo "=== WORKDIR = ${{ env.WORKDIR }} ==="
          ls -la "${{ env.WORKDIR }}" || true
          echo "=== android/ contents (if any) ==="
          ls -la "${{ env.WORKDIR }}/android" || true
          echo "=== check key files ==="
          if [ -f "${{ env.WORKDIR }}/android/app/build.gradle" ]; then
            echo "Found android/app/build.gradle"
          else
            echo "Missing android/app/build.gradle"
          fi
          if [ -f "${{ env.WORKDIR }}/gradlew" ]; then
            echo "Found gradlew at repo root"
          fi

      - name: Fix missing Android project (flutter create) if needed
        run: |
          set -e
          if [ ! -d "${{ env.WORKDIR }}/android" ] || [ ! -f "${{ env.WORKDIR }}/android/app/build.gradle" ]; then
            echo "Android folder or build.gradle missing. Running 'flutter create --platforms=android .' in ${{ env.WORKDIR }}"
            pushd "${{ env.WORKDIR }}"
            flutter create --platforms=android .
            popd
          else
            echo "Android folder looks present."
          fi

      - name: Ensure gradlew executable
        run: |
          if [ -f "${{ env.WORKDIR }}/android/gradlew" ]; then
            chmod +x "${{ env.WORKDIR }}/android/gradlew" || true
          fi

      - name: Install Android SDK components (best-effort)
        run: |
          # Use existing ANDROID_SDK_ROOT or fallback
          ANDROID_SDK_ROOT="${ANDROID_SDK_ROOT:-/usr/local/lib/android/sdk}"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          export ANDROID_SDK_ROOT
          # ensure sdkmanager exists
          if [ -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            SDKMAN="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          elif command -v sdkmanager >/dev/null 2>&1; then
            SDKMAN=$(command -v sdkmanager)
          else
            echo "sdkmanager not found; skipping explicit SDK component install"
            SDKMAN=""
          fi
          if [ -n "$SDKMAN" ]; then
            yes | $SDKMAN "platform-tools" "platforms;android-33" "build-tools;33.0.2" || true
            yes | $SDKMAN --licenses || true
          fi

      - name: Install dependencies (flutter pub get)
        working-directory: ${{ env.WORKDIR }}
        run: |
          if [ -f pubspec.yaml ]; then
            flutter pub get --verbose
          else
            echo "No pubspec.yaml found in ${{ env.WORKDIR }}; aborting"
            exit 1
          fi

      - name: Build APK (verbose)
        working-directory: ${{ env.WORKDIR }}
        run: |
          set -o pipefail
          flutter build apk --release -v

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: ${{ env.WORKDIR }}/build/app/outputs/flutter-apk/*.apk
