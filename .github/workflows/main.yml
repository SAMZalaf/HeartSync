name: Flutter CI - robust install & build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      FLUTTER_CHANNEL: "stable"
      FLUTTER_GIT_URL: "https://github.com/flutter/flutter.git"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install unzip and git
        run: sudo apt-get update && sudo apt-get install -y unzip git

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Diagnostic - show runner info
        run: |
          echo "Runner: $RUNNER_OS"
          uname -a
          java -version
          env | sort

      - name: Try setup Flutter via subosito action
        id: flutter_action
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_CHANNEL }}
        continue-on-error: true

      - name: Check if flutter is available
        id: check_subosito
        run: |
          if command -v flutter >/dev/null 2>&1; then
            echo "subosito_ok=true" >> $GITHUB_OUTPUT
          else
            echo "subosito_ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Fallback - install Flutter from Git if action failed
        if: steps.check_subosito.outputs.subosito_ok == 'false'
        run: |
          echo "subosito action failed; installing Flutter from Git (stable)..."
          FLUTTER_DIR="${RUNNER_TEMP}/flutter"
          rm -rf "$FLUTTER_DIR"
          git clone --depth 1 --branch ${{ env.FLUTTER_CHANNEL }} ${{ env.FLUTTER_GIT_URL }} "$FLUTTER_DIR"
          echo "$FLUTTER_DIR/bin" >> $GITHUB_PATH
          echo "FLUTTER_DIR=$FLUTTER_DIR" >> $GITHUB_ENV
          flutter --version || true

      - name: Ensure FLUTTER_DIR env if subosito succeeded
        if: steps.check_subosito.outputs.subosito_ok == 'true'
        run: |
          # If subosito installed flutter, ensure FLUTTER_DIR points to its bin parent (best-effort)
          FLUTTER_BIN=$(command -v flutter || true)
          if [ -n "$FLUTTER_BIN" ]; then
            FLUTTER_DIR=$(dirname "$(dirname "$FLUTTER_BIN")")
            echo "FLUTTER_DIR=$FLUTTER_DIR" >> $GITHUB_ENV
          fi

      - name: Final check - flutter version
        run: |
          if command -v flutter >/dev/null 2>&1; then
            echo "Flutter is installed:"
            flutter --version
          else
            echo "ERROR: Flutter is not installed. Failing the job."
            exit 1
          fi

      - name: Find latest zip file
        id: findzip
        run: |
          ZIP=$(git ls-files '*.zip' 2>/dev/null | xargs -I{} stat -c "%Y %n" {} 2>/dev/null | sort -nr | head -n1 | awk '{print $2}' || true)
          if [ -z "$ZIP" ]; then
            echo "no_zip=true" >> $GITHUB_OUTPUT
          else
            echo "zip_path=$ZIP" >> $GITHUB_OUTPUT
            echo "no_zip=false" >> $GITHUB_OUTPUT
          fi

      - name: Unzip if found
        if: steps.findzip.outputs.no_zip == 'false'
        run: |
          echo "Unzipping ${{ steps.findzip.outputs.zip_path }}"
          mkdir -p extracted
          unzip -o "${{ steps.findzip.outputs.zip_path }}" -d extracted
          ls -la extracted

      - name: Set working directory (auto-detect pubspec)
        id: workdir
        run: |
          ROOT="."
          if [ -d extracted ] && [ "$(ls -A extracted)" ]; then
            ROOT="extracted"
          fi
          PUBSPEC_DIR=$(find "$ROOT" -maxdepth 3 -type f -name pubspec.yaml -printf '%h\n' | head -n1 || true)
          if [ -n "$PUBSPEC_DIR" ]; then
            echo "WORKDIR=$PUBSPEC_DIR" >> $GITHUB_ENV
            echo "Found pubspec at: $PUBSPEC_DIR"
          else
            echo "WORKDIR=$ROOT" >> $GITHUB_ENV
            echo "No pubspec.yaml found; using $ROOT"
          fi
          echo "WORKDIR set to $WORKDIR"

      - name: Cache pub packages
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      - name: Install dependencies
        working-directory: ${{ env.WORKDIR }}
        run: |
          if [ -f pubspec.yaml ]; then
            flutter pub get --verbose
          else
            echo "No pubspec.yaml found in ${{ env.WORKDIR }}; skipping pub get"
          fi

      - name: Show Android SDK and licenses (diagnostic)
        run: |
          echo "Android SDK root: $ANDROID_SDK_ROOT"
          yes | sdkmanager --licenses || true
        continue-on-error: true

      - name: Build APK
        working-directory: ${{ env.WORKDIR }}
        run: |
          set -o pipefail
          flutter build apk --release -v

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: ${{ env.WORKDIR }}/build/app/outputs/flutter-apk/*.apk
