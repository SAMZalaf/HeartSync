name: Build and commit APK to main

on:
  push:
    branches: [ main ]
    paths:
      - 'extracted/fkDGTlmlf/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_and_commit_apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Java & unzip
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget zip libglu1-mesa
          sudo apt-get install -y openjdk-17-jdk

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 'stable'

      - name: Build APK
        working-directory: extracted/fkDGTlmlf
        run: |
          flutter pub get
          flutter build apk --release

      - name: Copy APK to repo root
        run: |
          cp extracted/fkDGTlmlf/build/app/outputs/flutter-apk/app-release.apk ./heartsync-release.apk
          ls -lh heartsync-release.apk

      - name: Commit and push APK to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add heartsync-release.apk
          git commit -m "Add release APK to main [skip ci]" || echo "No changes to commit"
          git push origin main
      - name: Setup Flutter (subosito) - allow failure
        id: flutter_action
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_CHANNEL }}
        continue-on-error: true

      - name: Ensure flutter available (fallback to git clone)
        if: ${{ failure() }}
        run: |
          if ! command -v flutter >/dev/null 2>&1; then
            echo "Installing Flutter from git (stable) as fallback..."
            FLUTTER_DIR="${RUNNER_TEMP}/flutter"
            rm -rf "$FLUTTER_DIR"
            git clone --depth 1 --branch ${{ env.FLUTTER_CHANNEL }} ${{ env.FLUTTER_GIT_URL }} "$FLUTTER_DIR"
            echo "$FLUTTER_DIR/bin" >> $GITHUB_PATH
            echo "$FLUTTER_DIR/bin/cache/dart-sdk/bin" >> $GITHUB_PATH || true
          fi

      - name: Confirm Flutter & Java
        run: |
          java -version || true
          flutter --version || true

      - name: Ensure Android SDK (best-effort)
        run: |
          sudo mkdir -p $ANDROID_SDK_ROOT
          sudo chown -R $USER:$USER $ANDROID_SDK_ROOT || true
          # Try to use sdkmanager if present; on GitHub runners it may already exist
          if command -v sdkmanager >/dev/null 2>&1; then
            yes | sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.2" || true
            yes | sdkmanager --licenses || true
          else
            echo "sdkmanager not found; relying on runner default Android SDK"
          fi

      - name: Set project WORKDIR
        id: set_workdir
        run: |
          # Use extracted/fkDGTlmlf as project root
          WORKDIR="extracted/fkDGTlmlf"
          if [ ! -d "$WORKDIR" ]; then
            echo "ERROR: $WORKDIR not found. Listing repo root:"
            ls -la .
            exit 1
          fi
          echo "WORKDIR=$WORKDIR" >> $GITHUB_ENV
          echo "Using WORKDIR: $WORKDIR"

      - name: Diagnostic - list project files
        run: |
          echo "=== Listing ${{ env.WORKDIR }} ==="
          ls -la "${{ env.WORKDIR }}" || true
          echo "=== Listing android/ (if exists) ==="
          ls -la "${{ env.WORKDIR }}/android" || true

      - name: Ensure gradlew executable (if present)
        run: |
          if [ -f "${{ env.WORKDIR }}/android/gradlew" ]; then
            chmod +x "${{ env.WORKDIR }}/android/gradlew" || true
          fi

      - name: Flutter pub get
        working-directory: ${{ env.WORKDIR }}
        run: flutter pub get --verbose

      - name: Build APK (release)
        working-directory: ${{ env.WORKDIR }}
        run: |
          set -o pipefail
          flutter build apk --release -v

      - name: Build AAB (release)
        working-directory: ${{ env.WORKDIR }}
        run: |
          set -o pipefail
          flutter build appbundle --release -v

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: ${{ env.WORKDIR }}/build/app/outputs/flutter-apk/*.apk

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: ${{ env.WORKDIR }}/build/app/outputs/bundle/release/*.aab
