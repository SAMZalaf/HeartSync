name: Build and commit HeartSync APK

on:
  push:
    branches: [ main ]
    paths:
      - 'extracted/fkDGTlmlf/**'
      - 'pubspec.yaml'
      - 'puscec.yaml'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: build-and-commit-apk
  cancel-in-progress: true

jobs:
  build_and_commit_apk:
    runs-on: ubuntu-latest
    env:
      WORKDIR: extracted/fkDGTlmlf
      OUT_NAME: heartsync-release.apk
      FLUTTER_GIT_URL: https://github.com/flutter/flutter.git
      FLUTTER_BRANCH: stable

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget zip libglu1-mesa openjdk-17-jdk git

      - name: Install Flutter SDK from git (stable)
        id: install_flutter
        run: |
          FLUTTER_DIR="${RUNNER_TEMP}/flutter"
          echo "Installing Flutter into $FLUTTER_DIR"
          rm -rf "$FLUTTER_DIR"
          git clone --depth 1 --branch "$FLUTTER_BRANCH" "$FLUTTER_GIT_URL" "$FLUTTER_DIR"
          echo "$FLUTTER_DIR/bin" >> $GITHUB_PATH
          echo "$FLUTTER_DIR/bin/cache/dart-sdk/bin" >> $GITHUB_PATH
          flutter --version || true
          flutter precache --android || true
          flutter doctor -v || true

      - name: Verify flutter installed
        run: |
          if ! command -v flutter >/dev/null 2>&1; then
            echo "ERROR: flutter not found after install"
            exit 1
          fi
          flutter --version

      - name: Diagnose project and ensure Android scaffolding
        working-directory: ${{ env.WORKDIR }}
        run: |
          echo "Project root listing:"
          ls -la
          echo "android folder listing (if exists):"
          ls -la android || true
          echo "android/app listing (if exists):"
          ls -la android/app || true
          # If android/app missing or build.gradle missing, generate scaffolding
          if [ ! -d "android/app" ] || [ ! -f "android/app/build.gradle" ]; then
            echo "Android app module missing or invalid â€” running flutter create to generate scaffolding"
            flutter create -t app .
          else
            echo "Android app module present"
          fi
          # Ensure gradlew executable if present
          if [ -f "android/gradlew" ]; then
            chmod +x android/gradlew || true
          fi
          echo "android/ contents:"
          ls -la android || true

      - name: Ensure google-services.json if template exists
        working-directory: ${{ env.WORKDIR }}
        run: |
          # If you keep a template, optionally copy it to google-services.json here.
          if [ -f "android/app/google-services.json.template" ] && [ ! -f "android/app/google-services.json" ]; then
            cp android/app/google-services.json.template android/app/google-services.json || true
            echo "Copied google-services.json.template to android/app/google-services.json"
          fi

      - name: Flutter pub get
        working-directory: ${{ env.WORKDIR }}
        run: flutter pub get --verbose

      - name: Build APK release
        working-directory: ${{ env.WORKDIR }}
        run: |
          set -o pipefail
          flutter build apk --release -v

      - name: Locate built APK
        id: find_apk
        working-directory: ${{ env.WORKDIR }}
        run: |
          APK_PATH=$(find build/app/outputs -type f -name "*.apk" -print -quit || true)
          if [ -z "$APK_PATH" ]; then
            echo "apk_found=false" >> $GITHUB_OUTPUT
            echo "No APK found under build/app/outputs"
            exit 0
          else
            echo "apk_found=true" >> $GITHUB_OUTPUT
            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
            echo "Found APK: $APK_PATH"
          fi

      - name: Copy APK to repo root
        if: steps.find_apk.outputs.apk_found == 'true'
        run: |
          cp "${{ steps.find_apk.outputs.apk_path }}" "./${{ env.OUT_NAME }}"
          ls -lh "./${{ env.OUT_NAME }}"

      - name: Commit APK using GITHUB_TOKEN
        if: steps.find_apk.outputs.apk_found == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "${{ env.OUT_NAME }}"
          git commit -m "Add HeartSync release APK [skip ci]" || echo "No changes to commit"
          git push origin main || echo "Push with GITHUB_TOKEN failed; will try PAT if provided"

      - name: Commit and push using Personal Access Token if provided
        if: steps.find_apk.outputs.apk_found == 'true' && secrets.PERSONAL_TOKEN != ''
        run: |
          # Use PAT stored in secrets.PERSONAL_TOKEN to push when branch protection blocks GITHUB_TOKEN
          git remote set-url origin https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/${{ github.repository }}
          git push origin main

      - name: Final listing of repo root
        if: steps.find_apk.outputs.apk_found == 'true'
        run: ls -la
