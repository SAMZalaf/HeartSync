name: Build and commit HeartSync APK

on:
  push:
    branches: [ main ]
    paths:
      - 'extracted/fkDGTlmlf/**'
      - 'pubspec.yaml'
      - 'puscec.yaml'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: build-and-commit-apk
  cancel-in-progress: true

jobs:
  build_and_commit_apk:
    runs-on: ubuntu-latest
    env:
      WORKDIR: extracted/fkDGTlmlf
      OUT_NAME: heartsync-release.apk
      FLUTTER_CHANNEL: stable
      FLUTTER_GIT_URL: https://github.com/flutter/flutter.git

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget zip libglu1-mesa openjdk-17-jdk git

      - name: Try setup Flutter action
        id: flutter_action
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_CHANNEL }}
        continue-on-error: true

      - name: Fallback install Flutter from git if needed
        if: ${{ steps.flutter_action.outcome == 'failure' }}
        run: |
          if ! command -v flutter >/dev/null 2>&1; then
            echo "Installing Flutter from git (stable) as fallback..."
            FLUTTER_DIR="${RUNNER_TEMP}/flutter"
            rm -rf "$FLUTTER_DIR"
            git clone --depth 1 --branch "$FLUTTER_CHANNEL" "$FLUTTER_GIT_URL" "$FLUTTER_DIR"
            echo "$FLUTTER_DIR/bin" >> $GITHUB_PATH
            echo "$FLUTTER_DIR/bin/cache/dart-sdk/bin" >> $GITHUB_PATH || true
          else
            echo "flutter already installed, skipping fallback"
          fi

      - name: Confirm Flutter and Java
        run: |
          java -version || true
          flutter --version || true

      - name: Verify project exists
        run: |
          if [ ! -d "${{ env.WORKDIR }}" ]; then
            echo "ERROR: Project folder ${{ env.WORKDIR }} not found"
            ls -la
            exit 1
          fi
          echo "Using project folder: ${{ env.WORKDIR }}"

      - name: Flutter pub get
        working-directory: ${{ env.WORKDIR }}
        run: flutter pub get --verbose

      - name: Build APK release
        working-directory: ${{ env.WORKDIR }}
        run: |
          set -o pipefail
          flutter build apk --release -v

      - name: Locate built APK
        id: find_apk
        run: |
          APK_PATH=$(find build/app/outputs -type f -name "*.apk" -print -quit || true)
          if [ -z "$APK_PATH" ]; then
            echo "apk_found=false" >> $GITHUB_OUTPUT
            echo "No APK found under build/app/outputs"
          else
            echo "apk_found=true" >> $GITHUB_OUTPUT
            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
            echo "Found APK: $APK_PATH"
          fi

      - name: Copy APK to repo root
        if: steps.find_apk.outputs.apk_found == 'true'
        run: |
          cp "${{ steps.find_apk.outputs.apk_path }}" "./${{ env.OUT_NAME }}"
          ls -lh "./${{ env.OUT_NAME }}"

      - name: Commit and push APK to main
        if: steps.find_apk.outputs.apk_found == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "${{ env.OUT_NAME }}"
          git commit -m "Add HeartSync release APK [skip ci]" || echo "No changes to commit"
          git push origin main
