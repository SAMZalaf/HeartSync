name: Build and publish HeartSync APK to branch

on:
  push:
    branches: [ main ]
    paths:
      - 'extracted/fkDGTlmlf/**'
      - 'pubspec.yaml'
      - 'puscec.yaml'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: build-and-publish-apk
  cancel-in-progress: true

jobs:
  build_and_publish_apk:
    runs-on: ubuntu-latest
    env:
      WORKDIR: extracted/fkDGTlmlf
      OUT_NAME: heartsync-release.apk
      FLUTTER_GIT_URL: https://github.com/flutter/flutter.git
      FLUTTER_BRANCH: stable

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget zip libglu1-mesa openjdk-17-jdk git

      - name: Install Flutter SDK from git (stable)
        run: |
          FLUTTER_DIR="${RUNNER_TEMP}/flutter"
          rm -rf "$FLUTTER_DIR"
          git clone --depth 1 --branch "$FLUTTER_BRANCH" "$FLUTTER_GIT_URL" "$FLUTTER_DIR"
          echo "$FLUTTER_DIR/bin" >> $GITHUB_PATH
          echo "$FLUTTER_DIR/bin/cache/dart-sdk/bin" >> $GITHUB_PATH
          flutter --version || true
          flutter precache --android || true

      - name: Diagnose project and ensure Android scaffolding
        working-directory: ${{ env.WORKDIR }}
        run: |
          echo "Listing project root:"
          ls -la
          echo "Checking android/app:"
          ls -la android/app || true
          if [ ! -d "android/app" ] || [ ! -f "android/app/build.gradle" ]; then
            echo "Android module missing or invalid â€” running flutter create"
            flutter create -t app .
          fi
          if [ -f "android/gradlew" ]; then chmod +x android/gradlew || true; fi

      - name: Ensure google-services.json if template exists
        working-directory: ${{ env.WORKDIR }}
        run: |
          if [ -f "android/app/google-services.json.template" ] && [ ! -f "android/app/google-services.json" ]; then
            cp android/app/google-services.json.template android/app/google-services.json || true
            echo "Copied google-services.json.template"
          fi

      - name: Flutter pub get
        working-directory: ${{ env.WORKDIR }}
        run: flutter pub get --verbose

      - name: Build APK release (increase Gradle heap, split per ABI)
        working-directory: ${{ env.WORKDIR }}
        env:
          GRADLE_OPTS: "-Xmx3g -Dorg.gradle.jvmargs=-Xmx3g -Dkotlin.daemon.jvm.options=-Xmx1g"
          JAVA_TOOL_OPTIONS: "-Xmx3g"
        run: |
          set -o pipefail
          export GRADLE_OPTS="${GRADLE_OPTS} --max-workers=2"
          echo "Using GRADLE_OPTS=$GRADLE_OPTS"
          # Try split-per-abi first to reduce peak memory usage
          flutter build apk --release --split-per-abi -v || {
            echo "Split-per-ABI build failed; trying single APK with reduced workers and no shrink"
            flutter build apk --release -v --no-shrink || exit 1
          }

      - name: Locate built APK
        id: find_apk
        working-directory: ${{ env.WORKDIR }}
        run: |
          # Find any apk under outputs (handles split-per-abi or single APK)
          APK_PATH=$(find build/app/outputs -type f -name "*.apk" -print -quit || true)
          if [ -z "$APK_PATH" ]; then
            echo "apk_found=false" >> $GITHUB_OUTPUT
            echo "No APK found"
            exit 0
          else
            echo "apk_found=true" >> $GITHUB_OUTPUT
            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
            echo "Found APK: $APK_PATH"
          fi

      - name: Copy APK to repo root
        if: steps.find_apk.outputs.apk_found == 'true'
        run: |
          cp "${{ steps.find_apk.outputs.apk_path }}" "./${{ env.OUT_NAME }}"
          ls -lh "./${{ env.OUT_NAME }}"

      - name: Create release branch and commit APK
        if: steps.find_apk.outputs.apk_found == 'true'
        env:
          SHORT_SHA: ${{ github.sha }}
        run: |
          set -e
          SHORT=${SHORT_SHA::7}
          TS=$(date -u +"%Y%m%d%H%M%S")
          BRANCH="apk/${SHORT}-${TS}"
          echo "Creating branch: $BRANCH"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH"
          git add "${{ env.OUT_NAME }}"
          git commit -m "Add HeartSync APK ${SHORT} (${TS}) [skip ci]" || echo "No changes to commit"

          echo "Attempting push with GITHUB_TOKEN..."
          if git push origin "$BRANCH"; then
            echo "Pushed branch $BRANCH with GITHUB_TOKEN"
            echo "BRANCH_NAME=$BRANCH" >> $GITHUB_OUTPUT
          else
            echo "Push with GITHUB_TOKEN failed; will mark for PAT retry"
            echo "$BRANCH" > /tmp/branch_to_push.txt
          fi

      - name: Retry push using Personal Access Token (PAT) if needed
        if: steps.find_apk.outputs.apk_found == 'true'
        env:
          PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          if [ ! -f /tmp/branch_to_push.txt ]; then
            echo "No retry needed; branch already pushed."
            exit 0
          fi
          if [ -z "${PERSONAL_TOKEN}" ]; then
            echo "PERSONAL_TOKEN not provided; cannot retry push. Exiting with failure."
            exit 1
          fi
          BRANCH=$(cat /tmp/branch_to_push.txt)
          echo "Retrying push of branch $BRANCH using PAT"
          git remote set-url origin https://x-access-token:${PERSONAL_TOKEN}@github.com/${{ github.repository }}
          if git push origin "$BRANCH"; then
            echo "Pushed branch $BRANCH with PAT"
            echo "BRANCH_NAME=$BRANCH" >> $GITHUB_OUTPUT
          else
            echo "PAT push failed"
            exit 1
          fi

      - name: Output branch info
        if: steps.find_apk.outputs.apk_found == 'true'
        run: |
          echo "APK branch created (if push succeeded, branch name printed above)."
          git branch -vv || true
