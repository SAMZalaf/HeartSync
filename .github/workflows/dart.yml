name: Build and publish HeartSync APK to branch

on:
  push:
    branches: [ main ]
    paths:
      - 'extracted/fkDGTlmlf/**'
      - 'pubspec.yaml'
      - 'puscec.yaml'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: build-and-publish-apk
  cancel-in-progress: true

jobs:
  build_and_publish_apk:
    runs-on: ubuntu-latest
    env:
      WORKDIR: extracted/fkDGTlmlf
      OUT_NAME: heartsync-release.apk
      FLUTTER_GIT_URL: https://github.com/flutter/flutter.git
      FLUTTER_BRANCH: stable

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget zip libglu1-mesa openjdk-17-jdk git

      - name: Install Flutter SDK from git (stable)
        run: |
          FLUTTER_DIR="${RUNNER_TEMP}/flutter"
          rm -rf "$FLUTTER_DIR"
          git clone --depth 1 --branch "$FLUTTER_BRANCH" "$FLUTTER_GIT_URL" "$FLUTTER_DIR"
          echo "$FLUTTER_DIR/bin" >> $GITHUB_PATH
          echo "$FLUTTER_DIR/bin/cache/dart-sdk/bin" >> $GITHUB_PATH
          flutter --version || true
          flutter precache --android || true

      - name: Diagnose project and ensure Android scaffolding
        working-directory: ${{ env.WORKDIR }}
        run: |
          echo "Listing project root:"
          ls -la
          echo "Checking android/app:"
          ls -la android/app || true
          if [ ! -d "android/app" ] || [ ! -f "android/app/build.gradle" ]; then
            echo "Android module missing or invalid â€” running flutter create"
            flutter create -t app .
          fi
          if [ -f "android/gradlew" ]; then chmod +x android/gradlew || true; fi

      - name: Ensure google-services.json if template exists
        working-directory: ${{ env.WORKDIR }}
        run: |
          if [ -f "android/app/google-services.json.template" ] && [ ! -f "android/app/google-services.json" ]; then
            cp android/app/google-services.json.template android/app/google-services.json || true
            echo "Copied google-services.json.template"
          fi

      - name: Flutter pub get
        working-directory: ${{ env.WORKDIR }}
        run: flutter pub get --verbose

      - name: Build APK release
        working-directory: ${{ env.WORKDIR }}
        run: |
          set -o pipefail
          flutter build apk --release -v

      - name: Locate built APK
        id: find_apk
        working-directory: ${{ env.WORKDIR }}
        run: |
          APK_PATH=$(find build/app/outputs -type f -name "*.apk" -print -quit || true)
          if [ -z "$APK_PATH" ]; then
            echo "apk_found=false" >> $GITHUB_OUTPUT
            echo "No APK found"
            exit 0
          else
            echo "apk_found=true" >> $GITHUB_OUTPUT
            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
            echo "Found APK: $APK_PATH"
          fi

      - name: Copy APK to repo root
        if: steps.find_apk.outputs.apk_found == 'true'
        run: |
          cp "${{ steps.find_apk.outputs.apk_path }}" "./${{ env.OUT_NAME }}"
          ls -lh "./${{ env.OUT_NAME }}"

      - name: Create release branch and commit APK
        if: steps.find_apk.outputs.apk_found == 'true'
        env:
          SHORT_SHA: ${{ github.sha }}
        run: |
          # Prepare branch name: apk/<short-sha>-YYYYMMDDHHMMSS
          SHORT=${SHORT_SHA::7}
          TS=$(date -u +"%Y%m%d%H%M%S")
          BRANCH="apk/${SHORT}-${TS}"
          echo "Creating branch: $BRANCH"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Create branch from current HEAD
          git checkout -b "$BRANCH"

          # Add APK and commit with skip ci
          git add "${{ env.OUT_NAME }}"
          git commit -m "Add HeartSync APK ${SHORT} (${TS}) [skip ci]" || echo "No changes to commit"

          # Try push with GITHUB_TOKEN (persist-credentials: true)
          echo "Pushing branch with GITHUB_TOKEN..."
          if git push origin "$BRANCH"; then
            echo "Pushed branch $BRANCH with GITHUB_TOKEN"
            echo "BRANCH_NAME=$BRANCH" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "Push with GITHUB_TOKEN failed; will attempt PAT if provided"
            exit 2
          fi

      - name: Retry push using Personal Access Token (PAT) if needed
        if: steps.find_apk.outputs.apk_found == 'true'
        env:
          PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          # This step runs only if previous push failed (exit code 2 triggers job failure by default).
          # To ensure we reach this step, we check if PERSONAL_TOKEN exists and remote branch not present.
          if [ -z "${PERSONAL_TOKEN}" ]; then
            echo "No PERSONAL_TOKEN provided; cannot retry push. Exiting."
            exit 0
          fi

          # Determine branch name from git (current branch)
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "Retrying push of branch $BRANCH using PAT"

          # Set remote URL with PAT and push
          git remote set-url origin https://x-access-token:${PERSONAL_TOKEN}@github.com/${{ github.repository }}
          if git push origin "$BRANCH"; then
            echo "Pushed branch $BRANCH with PAT"
            echo "BRANCH_NAME=$BRANCH" >> $GITHUB_OUTPUT
          else
            echo "PAT push failed"
            exit 1
          fi

      - name: Output branch info
        if: steps.find_apk.outputs.apk_found == 'true'
        run: |
          echo "APK branch created. See branch name in workflow outputs or check repository branches."
          git branch -vv
